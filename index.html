<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Research Survey</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font for SVG -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- SortableJS for Drag and Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        // Enable class-based dark mode in Tailwind
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'apple-blue': '#0071e3',
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom base styles */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif, "SF Pro Icons";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom radio button styling */
        .custom-radio {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem; /* 20px */
            width: 1.25rem; /* 20px */
            border: 1.5px solid #d1d5db; /* gray-300 */
            border-radius: 50%;
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0; 
        }
        .dark .custom-radio {
            border-color: #6b7280; /* dark:gray-500 */
        }
        .custom-radio:checked {
            border-color: #0071e3; /* apple-blue */
            background-color: #0071e3;
        }
        .custom-radio::before {
            content: '';
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-radio:checked::before {
            transform: scale(1);
        }

        /* Custom checkbox styling */
        .custom-checkbox {
            appearance: none;
            -webkit-appearance: none;
            height: 1.25rem; /* 20px */
            width: 1.25rem; /* 20px */
            border: 1.5px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* MODIFIED: More rounded */
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            flex-shrink: 0;
        }
        .dark .custom-checkbox {
            border-color: #6b7280; /* dark:gray-500 */
        }
        .custom-checkbox:checked {
            border-color: #0071e3; /* apple-blue */
            background-color: #0071e3;
        }
        .custom-checkbox::before {
            content: '';
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em white;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Style for the theme toggle dot */
        #theme-toggle:checked ~ .dot,
        #spacing-toggle:checked ~ .dot {
            transform: translateX(1.5rem); /* 24px */
        }
        /* Settings Panel Styling */
        #settings-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        /* Allow clicks to pass through the disabled button to its container */
        #next-button:disabled {
            pointer-events: none;
        }
        /* Instruction text styling for error state */
        .instruction-text {
            display: inline-block;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* p-1 px-2 */
            transition: all 0.2s ease-in-out;
        }
        .instruction-text.error {
            background-color: #fc3d39;
            color: #fff !important; /* Ensure text is always white on error */
        }
        /* Spacing indicator styles */
        .spacing-indicator {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 113, 227, 0.1);
            border: 1px dashed #0071e3;
            color: #0071e3;
            font-size: 12px;
            font-weight: 500;
            width: 100%;
            left: 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
            z-index: 50;
            pointer-events: none;
        }
        /* Hide number input arrows */
        .cs-input::-webkit-outer-spin-button,
        .cs-input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        .cs-input[type=number] {
          -moz-appearance: textfield;
        }
        /* Rank Order Styles */
        .rank-item {
            cursor: grab;
        }
        .rank-badge {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .rank-badge.unranked {
            background-color: transparent;
            color: transparent;
            border: 1.5px solid transparent;
        }
        .dark .rank-badge.unranked {
            background-color: transparent;
        }
        .rank-badge.ranked, .rank-badge.user-ranked {
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            border: 1.5px solid #1f2937; /* gray-800 */
        }
        .dark .rank-badge.ranked, .dark .rank-badge.user-ranked {
            background-color: #374151; /* dark:gray-700 */
            color: #f9fafb; /* dark:gray-50 */
            border: 1.5px solid #d1d5db; /* gray-300 */
        }
        #rank-order-list.is-ranked .drag-handle {
            color: #0071e3; /* apple-blue */
        }
        /* Custom Select Styling */
        .custom-select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
    </style>
</head>
<body class="bg-gray-200 dark:bg-black min-h-screen transition-colors duration-300 p-4 pb-20 flex items-start justify-center">

    <!-- Header Controls: Settings Toggle -->
    <div class="fixed bottom-24 left-4 flex items-center space-x-4 z-20">
        <button id="settings-toggle" class="text-gray-600 dark:text-gray-400 hover:text-black dark:hover:text-white transition-colors bg-white dark:bg-gray-800 p-3 rounded-full shadow-lg">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="hidden fixed bottom-40 left-4 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 w-72 opacity-0 transform scale-95 z-10">
        <h3 class="font-semibold text-lg mb-4 text-gray-800 dark:text-gray-100">Settings</h3>
        <div class="space-y-4">
            <!-- Theme Toggle -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Theme</label>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Light / Dark</span>
                    <label for="theme-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="theme-toggle" class="sr-only">
                            <div class="w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full shadow-inner"></div>
                            <div class="dot absolute w-4 h-4 bg-white rounded-full shadow-md inset-y-0 left-0 my-1 ml-1 transition-transform duration-300 ease-in-out"></div>
                        </div>
                    </label>
                </div>
            </div>
            <hr class="dark:border-gray-600">
            <!-- Designer Tools -->
            <div>
                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Designer Tools</label>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Show Spacing</span>
                    <label for="spacing-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="spacing-toggle" class="sr-only">
                            <div class="w-12 h-6 bg-gray-300 dark:bg-gray-600 rounded-full shadow-inner"></div>
                            <div class="dot absolute w-4 h-4 bg-white rounded-full shadow-md inset-y-0 left-0 my-1 ml-1 transition-transform duration-300 ease-in-out"></div>
                        </div>
                    </label>
                </div>
                 <div class="flex justify-between items-center mt-2 mb-1">
                    <label for="image-size" class="text-sm font-medium text-gray-700 dark:text-gray-300">Image Size</label>
                    <span id="image-size-value" class="text-sm text-gray-500 dark:text-gray-400">50%</span>
                </div>
                <input id="image-size" type="range" min="35" max="100" step="5" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                <div class="flex justify-between items-center mt-2 mb-1">
                    <label for="card-width-slider" class="text-sm font-medium text-gray-700 dark:text-gray-300">Card Width</label>
                    <span id="card-width-value" class="text-sm text-gray-500 dark:text-gray-400">820px</span>
                </div>
                <input id="card-width-slider" type="range" min="500" max="1024" step="8" value="820" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            </div>
            <hr class="dark:border-gray-600">
            <!-- Font size settings -->
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="question-size" class="text-sm font-medium text-gray-700 dark:text-gray-300">Question</label>
                    <span id="question-size-value" class="text-sm text-gray-500 dark:text-gray-400">19px</span>
                </div>
                <input id="question-size" type="range" min="18" max="30" value="19" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="instruction-size" class="text-sm font-medium text-gray-700 dark:text-gray-300">Instruction</label>
                    <span id="instruction-size-value" class="text-sm text-gray-500 dark:text-gray-400">16px</span>
                </div>
                <input id="instruction-size" type="range" min="14" max="24" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <label for="choice-size" class="text-sm font-medium text-gray-700 dark:text-gray-300">Choices</label>
                    <span id="choice-size-value" class="text-sm text-gray-500 dark:text-gray-400">16px</span>
                </div>
                <input id="choice-size" type="range" min="14" max="24" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
            </div>
            <hr class="dark:border-gray-600">
            <!-- Question Jump -->
            <div>
                <label for="question-jump" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jump to Question</label>
                <select id="question-jump" class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-apple-blue focus:border-apple-blue block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-apple-blue dark:focus:border-apple-blue">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
        </div>
    </div>

    <!-- Main container for the survey form -->
    <div id="main-content" class="relative bg-white dark:bg-gray-800 w-[90%] max-w-[820px] mx-auto px-6 sm:px-10 md:px-16 pb-8 rounded-xl">
        
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="hidden text-center pt-12">
            <div id="logo-container" class="text-center mb-6 pt-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" class="w-12 h-12 mx-auto text-black dark:text-white fill-current">  <path d="M349.13,136.86c-40.32,0-57.36,19.24-85.44,19.24C234.9,156.1,212.94,137,178,137c-34.2,0-70.67,20.88-93.83,56.45-32.52,50.16-27,144.63,25.67,225.11,18.84,28.81,44,61.12,77,61.47h.6c28.68,0,37.2-18.78,76.67-19h.6c38.88,0,46.68,18.89,75.24,18.89h.6c33-.35,59.51-36.15,78.35-64.85,13.56-20.64,18.6-31,29-54.35-76.19-28.92-88.43-136.93-13.08-178.34-23-28.8-55.32-45.48-85.79-45.48Z"/>  <path d="M340.25,32c-24,1.63-52,16.91-68.4,36.86-14.88,18.08-27.12,44.9-22.32,70.91h1.92c25.56,0,51.72-15.39,67-35.11C333.17,85.89,344.33,59.29,340.25,32Z"/></svg>
            </div>
            <div class="max-w-xs mx-auto mt-6 mb-12">
                <select id="language-select" class="custom-select w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-apple-blue focus:border-apple-blue block py-1 px-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-apple-blue dark:focus:border-apple-blue">
                    <option selected>English</option>
                    <option>Español</option>
                    <option>Français</option>
                    <option>Deutsch</option>
                    <option>日本語</option>
                </select>
            </div>
            <h1 class="text-4xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Let's get started!</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 max-w-md mx-auto">This survey should take 15 minutes or less of your time. Use the "Next" button to move through the survey.</p>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-4">We appreciate your feedback.</p>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-4">Apple</p>
            <img id="welcome-image" src="start.png" 
                 alt="A collection of illustrated electronic devices" class="w-1/4 max-w-lg mx-auto mt-12 transition-all duration-300"
                 onerror="this.onerror=null;this.src='https://placehold.co/996x394/f0f0f0/cccccc?text=Image+Not+Found';">
        </div>

        <div id="survey-content" class="hidden">
            <div id="logo-container-small" class="text-center mb-6 pt-6">
                 <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" class="w-9 h-9 mx-auto text-black dark:text-white fill-current">  <path d="M349.13,136.86c-40.32,0-57.36,19.24-85.44,19.24C234.9,156.1,212.94,137,178,137c-34.2,0-70.67,20.88-93.83,56.45-32.52,50.16-27,144.63,25.67,225.11,18.84,28.81,44,61.12,77,61.47h.6c28.68,0,37.2-18.78,76.67-19h.6c38.88,0,46.68,18.89,75.24,18.89h.6c33-.35,59.51-36.15,78.35-64.85,13.56-20.64,18.6-31,29-54.35-76.19-28.92-88.43-136.93-13.08-178.34-23-28.8-55.32-45.48-85.79-45.48Z"/>  <path d="M340.25,32c-24,1.63-52,16.91-68.4,36.86-14.88,18.08-27.12,44.9-22.32,70.91h1.92c25.56,0,51.72-15.39,67-35.11C333.17,85.89,344.33,59.29,340.25,32Z"/></svg>
            </div>
            
            <div id="progress-container" class="w-3/5 mx-auto mb-6">
                <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-1">
                    <div id="progress-bar" class="bg-apple-blue h-1 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Question 1: Satisfaction -->
            <div id="question-1" class="hidden">
                <div class="max-w-2xl mx-auto">
                    <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">Overall, how satisfied are you with your Fruit Watch Ultra 2?</h1>
                    <div class="mb-6">
                        <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select one.</p>
                    </div>
                    <div id="choices-1-container" class="choices-container">
                        <label class="flex items-center py-3.5 border-t border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <input type="radio" name="satisfaction" class="custom-radio">
                            <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Very satisfied</span>
                        </label>
                        <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <input type="radio" name="satisfaction" class="custom-radio">
                            <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Somewhat satisfied</span>
                        </label>
                        <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <input type="radio" name="satisfaction" class="custom-radio">
                            <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Neither satisfied nor dissatisfied</span>
                        </label>
                        <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <input type="radio" name="satisfaction" class="custom-radio">
                            <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Somewhat dissatisfied</span>
                        </label>
                        <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <input type="radio" name="satisfaction" class="custom-radio">
                            <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Very dissatisfied</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Question 2: Matrix -->
            <div id="question-2" class="hidden">
                 <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">How much do you agree or disagree with each of these statements?</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select one answer per row.</p>
                </div>
                <table id="choices-2-container" class="w-full text-left text-sm choices-container">
                    <thead>
                        <tr class="choice-text text-gray-500 dark:text-gray-400">
                            <th class="w-2/5 pb-4 font-normal align-bottom"></th>
                            <th class="w-[12%] pb-4 font-normal text-center align-bottom">Strongly agree</th>
                            <th class="w-[12%] pb-4 font-normal text-center align-bottom">Somewhat agree</th>
                            <th class="w-[12%] pb-4 font-normal text-center align-bottom">Neither agree nor disagree</th>
                            <th class="w-[12%] pb-4 font-normal text-center align-bottom">Somewhat disagree</th>
                            <th class="w-[12%] pb-4 font-normal text-center align-bottom">Strongly disagree</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-choices">
                        <tr class="border-t border-b dark:border-gray-700">
                            <td class="py-3 text-gray-800 dark:text-gray-200 choice-text">I am a fan of Fruit products</td>
                            <td class="text-center"><input type="radio" name="q2-row1" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row1" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row1" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row1" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row1" class="custom-radio mx-auto"></td>
                        </tr>
                        <tr class="border-b dark:border-gray-700">
                            <td class="py-3 text-gray-800 dark:text-gray-200 choice-text">I give advice to friends and family on which technology products to buy</td>
                            <td class="text-center"><input type="radio" name="q2-row2" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row2" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row2" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row2" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row2" class="custom-radio mx-auto"></td>
                        </tr>
                        <tr class="border-b dark:border-gray-700">
                            <td class="py-3 text-gray-800 dark:text-gray-200 choice-text">I am among the first to try new technology products and services</td>
                            <td class="text-center"><input type="radio" name="q2-row3" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row3" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row3" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row3" class="custom-radio mx-auto"></td>
                            <td class="text-center"><input type="radio" name="q2-row3" class="custom-radio mx-auto"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Question 3: Large Matrix -->
            <div id="question-3" class="hidden">
                 <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">Please rate the following features.</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select one answer per row.</p>
                </div>
                <table id="choices-3-container" class="w-full text-left text-sm choices-container">
                    <thead>
                        <tr class="choice-text text-gray-500 dark:text-gray-400">
                            <th class="w-1/4 pb-4 font-normal align-bottom"></th>
                            <th class="pb-4 font-normal text-center align-bottom">Very Poor</th>
                            <th class="pb-4 font-normal text-center align-bottom">Poor</th>
                            <th class="pb-4 font-normal text-center align-bottom">Average</th>
                            <th class="pb-4 font-normal text-center align-bottom">Good</th>
                            <th class="pb-4 font-normal text-center align-bottom">Excellent</th>
                            <th class="pb-4 font-normal text-center align-bottom">N/A</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-choices-2">
                        <!-- 10 rows will be generated by JS -->
                    </tbody>
                </table>
            </div>
            
            <!-- Question 4: Multi-Select -->
            <div id="question-4" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">Which of the following did you do before getting your Apple Watch Series 10?</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select all that apply.</p>
                </div>
                <div id="choices-4-container" class="choices-container">
                    <label class="flex items-center py-3.5 border-t border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <input type="checkbox" name="q4_experience" class="custom-checkbox">
                        <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Checked the size and fit of your purchase at an Apple retail store</span>
                    </label>
                    <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <input type="checkbox" name="q4_experience" class="custom-checkbox">
                        <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Did an Apple Watch Series 10 demo with an Apple retail team member</span>
                    </label>
                    <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <input type="checkbox" name="q4_experience" class="custom-checkbox">
                        <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">Tried out Apple Watch Series 10 through a family member</span>
                    </label>
                    <label class="flex items-center py-3.5 border-b border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <input type="checkbox" name="q4_experience" id="q4-none" class="custom-checkbox">
                        <span class="ml-4 text-gray-700 dark:text-gray-300 choice-text">None of the above</span>
                    </label>
                </div>
            </div>

            <!-- Question 5: Matrix Multi-Select -->
            <div id="question-5" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">How do you typically pay for the following types of purchases?</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select all that apply for each type of purchase.</p>
                </div>
                <table id="choices-5-container" class="w-full text-left text-sm choices-container">
                    <thead>
                        <tr class="choice-text text-gray-500 dark:text-gray-400">
                            <th class="w-2/5 pb-4 font-normal align-bottom"></th>
                            <th class="w-[14%] pb-4 font-normal text-center align-bottom">Apple Card</th>
                            <th class="w-[14%] pb-4 font-normal text-center align-bottom">Other credit card(s)</th>
                            <th class="w-[14%] pb-4 font-normal text-center align-bottom">Other payment methods</th>
                            <th class="w-[14%] pb-4 font-normal text-center align-bottom">Does not apply</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-multiselect-choices">
                        <!-- Rows will be generated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Question 6: Open End -->
            <div id="question-6" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">This particular survey is for those who got an iPad. If you have any comments you would like to share with us, please use the textbox below.</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Be as specific and descriptive as possible.</p>
                </div>
                <div id="choices-6-container" class="choices-container">
                    <textarea id="open-end-response" rows="6" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-apple-blue focus:outline-none transition choice-text" placeholder="I absolutely love my new iPad Pro! The display is incredibly vibrant..."></textarea>
                </div>
            </div>

            <!-- Question 7: Constant Sum -->
            <div id="question-7" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">How is your time in Logic Pro X spread across these activities?</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select between 0% to 100% for each activity. Total of all categories should equal 100%.</p>
                </div>
                <div id="choices-7-container" class="choices-container space-y-px">
                    <div class="flex justify-between items-center py-3.5 border-t border-b border-gray-200 dark:border-gray-700">
                        <span class="text-gray-700 dark:text-gray-300 choice-text">Working alone creating my own music</span>
                        <div class="flex items-center">
                            <input type="number" min="0" max="100" value="0" oninput="this.value = Math.round(this.value); if(this.value > 100) this.value = 100; if(this.value < 0) this.value = 0;" class="cs-input w-11 h-8 text-center border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-apple-blue focus:outline-none">
                            <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3.5 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-gray-700 dark:text-gray-300 choice-text">Creating music with others in a group or band</span>
                        <div class="flex items-center">
                            <input type="number" min="0" max="100" value="0" oninput="this.value = Math.round(this.value); if(this.value > 100) this.value = 100; if(this.value < 0) this.value = 0;" class="cs-input w-11 h-8 text-center border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-apple-blue focus:outline-none">
                            <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3.5 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-gray-700 dark:text-gray-300 choice-text">Working as an audio engineer and/or producer for other people's projects</span>
                        <div class="flex items-center">
                            <input type="number" min="0" max="100" value="0" oninput="this.value = Math.round(this.value); if(this.value > 100) this.value = 100; if(this.value < 0) this.value = 0;" class="cs-input w-11 h-8 text-center border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-apple-blue focus:outline-none">
                            <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center py-3.5 border-b border-gray-200 dark:border-gray-700">
                        <span class="font-semibold text-gray-800 dark:text-gray-100 choice-text">Total</span>
                        <div class="flex items-center">
                            <input type="text" id="constant-sum-total" value="0" readonly class="w-11 h-8 text-center border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold">
                            <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Question 8: Rank Order -->
            <div id="question-8" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">Rank these items in order of importance in your decision to get the iPhone SE.</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Drag and drop the list items to rank them from most important (1) to least important (5).</p>
                </div>
                <div id="rank-order-list" class="choices-container">
                    <!-- Items will be generated by JS -->
                </div>
            </div>

            <!-- Question 9: Bipolar (Row Layout) -->
            <div id="question-9" class="hidden">
                <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">Below are some statements about how people feel about watching TV shows/series and movies. Think about your recent viewing experiences when answering which statement describes you better.</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Select one answer per row.</p>
                </div>
                <div class="choices-container">
                    <!-- Header for the radio scale -->
                    <div class="flex w-full text-center text-sm choice-text text-gray-500 dark:text-gray-400 mb-2">
                        <div class="w-[35%]"></div> <!-- Spacer for left text -->
                        <div class="flex-grow grid grid-cols-4 gap-2 px-2">
                            <span>Describes me much better<br>&lt;&lt;</span>
                            <span>Describes me somewhat better<br>&lt;</span>
                            <span>Describes me somewhat better<br>&gt;</span>
                            <span>Describes me much better<br>&gt;&gt;</span>
                        </div>
                        <div class="w-[35%]"></div> <!-- Spacer for right text -->
                    </div>
                    <!-- Container for generated rows -->
                    <div id="bipolar-flex-choices">
                        <!-- JS will populate this -->
                    </div>
                </div>
            </div>

            <!-- Question 10: New Long Matrix -->
            <div id="question-10" class="hidden">
                 <h1 class="question-text text-left text-gray-800 dark:text-gray-100 mb-2">How satisfied are you with each of the following Apple Intelligence features on your iPhone 16 Pro Max?</h1>
                <div class="mb-6">
                    <p class="instruction-text text-left text-gray-500 dark:text-gray-400">Apple Intelligence is available with Siri and device language set to U.S. English. Some features and additional languages will be coming in the future. Select one answer per row.</p>
                </div>
                <div class="overflow-x-auto">
                    <table id="choices-10-container" class="w-full text-left text-sm choices-container">
                        <thead>
                            <tr class="choice-text text-gray-500 dark:text-gray-400">
                                <th class="w-1/4 pb-4 font-normal align-bottom"></th>
                                <th class="pb-4 font-normal text-center align-bottom">Very satisfied</th>
                                <th class="pb-4 font-normal text-center align-bottom">Somewhat satisfied</th>
                                <th class="pb-4 font-normal text-center align-bottom">Neither satisfied nor dissatisfied</th>
                                <th class="pb-4 font-normal text-center align-bottom">Somewhat dissatisfied</th>
                                <th class="pb-4 font-normal text-center align-bottom">Very dissatisfied</th>
                                <th class="pb-4 font-normal text-center align-bottom">Haven't tried</th>
                            </tr>
                        </thead>
                        <tbody id="matrix-choices-3">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Thank You Screen -->
        <div id="thank-you" class="hidden text-center pt-12 pb-16">
            <div id="logo-container-thankyou" class="text-center mb-6 pt-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512" class="w-12 h-12 mx-auto text-black dark:text-white fill-current">  <path d="M349.13,136.86c-40.32,0-57.36,19.24-85.44,19.24C234.9,156.1,212.94,137,178,137c-34.2,0-70.67,20.88-93.83,56.45-32.52,50.16-27,144.63,25.67,225.11,18.84,28.81,44,61.12,77,61.47h.6c28.68,0,37.2-18.78,76.67-19h.6c38.88,0,46.68,18.89,75.24,18.89h.6c33-.35,59.51-36.15,78.35-64.85,13.56-20.64,18.6-31,29-54.35-76.19-28.92-88.43-136.93-13.08-178.34-23-28.8-55.32-45.48-85.79-45.48Z"/>  <path d="M340.25,32c-24,1.63-52,16.91-68.4,36.86-14.88,18.08-27.12,44.9-22.32,70.91h1.92c25.56,0,51.72-15.39,67-35.11C333.17,85.89,344.33,59.29,340.25,32Z"/></svg>
            </div>
            <h1 class="text-3xl font-semibold text-gray-800 dark:text-gray-100 mb-4">That's it!</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">Thank you for your thoughtful feedback.</p>
            <img src="thank.png" alt="Thank You!" class="mx-auto mt-2 w-full max-w-lg" onerror="this.onerror=null;this.src='https://placehold.co/800x400/f0f0f0/cccccc?text=Image+Not+Found';">
        </div>

        <div id="next-button-container" class="text-center mt-12">
            <button id="next-button" class="bg-apple-blue text-white font-medium py-2.5 px-16 rounded-full transition-colors duration-300 hover:bg-blue-700">Next</button>
        </div>

        <!-- Spacing Indicators (overlay) -->
        <div id="spacer-1" class="spacing-indicator hidden"></div>
        <div id="spacer-2" class="spacing-indicator hidden"></div>
        <div id="spacer-3" class="spacing-indicator hidden"></div>
        <div id="spacer-4" class="spacing-indicator hidden"></div>

    </div>

    <!-- Footer -->
    <footer class="fixed bottom-0 left-0 right-0 text-center p-4 text-xs text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
        Copyright © 2025 Fruit Inc. One Fruit Park Way, MS 923-4FIN, Cupertino, CA 95014 USA. | <a href="#" class="text-apple-blue hover:underline">Contact Us</a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let currentStep = 0; 
            const totalQuestions = 10; 
            let hasBeenDragged = false; // For rank order
            var resizeObserverFrameId;

            // --- Element References ---
            const htmlElement = document.documentElement;
            const mainContent = document.getElementById('main-content');
            const settingsToggle = document.getElementById('settings-toggle');
            const settingsPanel = document.getElementById('settings-panel');
            const themeToggle = document.getElementById('theme-toggle');
            const spacingToggle = document.getElementById('spacing-toggle');
            
            const questionSizeSlider = document.getElementById('question-size');
            const instructionSizeSlider = document.getElementById('instruction-size');
            const choiceSizeSlider = document.getElementById('choice-size');
            const imageSizeSlider = document.getElementById('image-size');
            const cardWidthSlider = document.getElementById('card-width-slider'); 

            const questionSizeValue = document.getElementById('question-size-value');
            const instructionSizeValue = document.getElementById('instruction-size-value');
            const choiceSizeValue = document.getElementById('choice-size-value');
            const imageSizeValue = document.getElementById('image-size-value');
            const cardWidthValue = document.getElementById('card-width-value'); 
            
            const nextButton = document.getElementById('next-button');
            const progressBar = document.getElementById('progress-bar');
            const nextButtonContainer = document.getElementById('next-button-container');
            const questionJump = document.getElementById('question-jump');
            const welcomeImage = document.getElementById('welcome-image');

            const stepContainers = [
                document.getElementById('welcome-screen'),
                document.getElementById('survey-content'),
                document.getElementById('thank-you')
            ];
            
            const questionContainers = [
                document.getElementById('question-1'),
                document.getElementById('question-2'),
                document.getElementById('question-3'),
                document.getElementById('question-4'),
                document.getElementById('question-5'),
                document.getElementById('question-6'),
                document.getElementById('question-7'),
                document.getElementById('question-8'),
                document.getElementById('question-9'),
                document.getElementById('question-10'),
            ];
            
            // --- Generate Dynamic Content ---
            // Q3 Matrix
            const matrixChoices2 = document.getElementById('matrix-choices-2');
            const q3Features = ['Battery Life', 'Screen Quality', 'Processing Speed', 'Camera Quality', 'Ease of Use', 'Design', 'App Availability', 'Durability', 'Value for Money', 'Customer Support'];
            q3Features.forEach((feature, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-b dark:border-gray-700';
                let cells = `<td class="py-3 text-gray-800 dark:text-gray-200 choice-text">${feature}</td>`;
                for (let i = 0; i < 6; i++) {
                    cells += `<td class="text-center"><input type="radio" name="q3-row${index}" class="custom-radio mx-auto"></td>`;
                }
                tr.innerHTML = cells;
                matrixChoices2.appendChild(tr);
            });

            // Q5 Matrix
            const matrixMultiSelectChoices = document.getElementById('matrix-multiselect-choices');
            const q5Rows = ['Apple products and services', 'Auto payments', 'Clothing', 'Drug stores', 'Electronics/Appliances'];
            q5Rows.forEach((rowText, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-b dark:border-gray-700';
                let cells = `<td class="py-3 text-gray-800 dark:text-gray-200 choice-text">${rowText}</td>`;
                for (let i = 0; i < 4; i++) {
                    cells += `<td class="text-center"><input type="checkbox" name="q5-row${index}" class="custom-checkbox mx-auto"></td>`;
                }
                tr.innerHTML = cells;
                matrixMultiSelectChoices.appendChild(tr);
            });

            // Q8 Rank Order
            const rankOrderList = document.getElementById('rank-order-list');
            const rankItems = ['Performance', 'Design', 'Low price', 'Camera quality', 'Small size'];
            rankItems.forEach(itemText => {
                const li = document.createElement('div');
                li.className = 'rank-item flex justify-between items-center py-3.5 border-b border-gray-200 dark:border-gray-700';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="rank-badge unranked mr-4"></span>
                        <span class="text-gray-700 dark:text-gray-300 choice-text">${itemText}</span>
                    </div>
                    <svg class="w-6 h-6 text-gray-400 dark:text-gray-500 drag-handle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 12h16M4 16h16"></path></svg>
                `;
                rankOrderList.appendChild(li);
            });

            // Q9 Bipolar Data & Generation
            const bipolarData = [
                { left: 'I tend to stick with the same types of TV shows/movies/genres', right: 'I prefer to explore new types of TV shows/movies/genres' },
                { left: 'I like to be the first one among friends/family to try a new show or movie', right: 'I wait to see if a show or movie gets buzz before I give it a try' },
                { left: 'I prefer watching TV shows/movies that seem unique and interesting, regardless of whether they are, or were, popular', right: 'I prefer watching TV shows/movies that are currently popular that everyone is talking about it' },
                { left: 'I seek out TV shows/movies that receive critical acclaim and/or awards, or are well reviewed', right: 'I don\'t care if TV shows/movies receive critical acclaim and/or awards, or are well-reviewed' }
            ];
            
            // Q9 Bipolar Row/Flex Generation
            const bipolarFlexChoices = document.getElementById('bipolar-flex-choices');
            bipolarData.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'flex items-center py-3.5 border-t border-gray-200 dark:border-gray-700';
                row.innerHTML = `
                    <div class="w-[35%] text-gray-800 dark:text-gray-200 choice-text text-left pr-4">${item.left}</div>
                    <div class="flex-grow grid grid-cols-4 gap-2 items-center">
                        <input type="radio" name="q9-row${index}" class="custom-radio justify-self-center">
                        <input type="radio" name="q9-row${index}" class="custom-radio justify-self-center">
                        <input type="radio" name="q9-row${index}" class="custom-radio justify-self-center">
                        <input type="radio" name="q9-row${index}" class="custom-radio justify-self-center">
                    </div>
                    <div class="w-[35%] text-gray-800 dark:text-gray-200 choice-text text-right pl-4">${item.right}</div>
                `;
                bipolarFlexChoices.appendChild(row);
            });

            // Q10 New Matrix Generation
            const matrixChoices3 = document.getElementById('matrix-choices-3');
            const q10Features = [
                'Phone call recording, transcription, summarization',
                'Audio recording, transcription and summarization in Notes',
                'Create a memory movie from your photo library',
                'Natural language search for photos and videos',
                'Photo Clean up',
                'Private Cloud Compute',
                "Apple's overall approach to privacy",
                'ChatGPT integration in Siri and Writing Tools',
                'Smart Replies in Mail and Messages',
                'Writing Tools that help proofread, rewrite or summarize any text',
                'Priority Messages and summaries in Mail',
                'Priority Notifications and summaries',
                'Genmoji (create your own emojis)',
                'Image Playground',
                'A smarter and more personal Siri'
            ];
            q10Features.forEach((feature, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-t border-b dark:border-gray-700';
                let cells = `<td class="py-3 text-gray-800 dark:text-gray-200 choice-text">${feature}</td>`;
                for (let i = 0; i < 6; i++) {
                    cells += `<td class="text-center"><input type="radio" name="q10-row${index}" class="custom-radio mx-auto"></td>`;
                }
                tr.innerHTML = cells;
                matrixChoices3.appendChild(tr);
            });

            // Question Jump Dropdown
            const questionTitles = [
                "1. Start", "2. single-select", "3. matrix", "4. multi-long", 
                "5. multi-select", "6. matrix-multi", "7. open-end", "8. constant sum", 
                "9. rank-order", "10. bipolar", "11. matrix-long2", "12. Thanks"
            ];
            questionJump.innerHTML = ''; // Clear existing options before adding new ones
            questionTitles.forEach((title, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = title;
                questionJump.appendChild(option);
            });

            const allQuestionText = document.querySelectorAll('.question-text');
            const allInstructionText = document.querySelectorAll('.instruction-text');
            const allChoiceText = document.querySelectorAll('.choice-text');

            // --- Theme Toggle Logic ---
            const applyTheme = (isDark) => {
                htmlElement.classList.toggle('dark', isDark);
                themeToggle.checked = isDark;
            };
            const savedTheme = localStorage.getItem('theme');
            applyTheme(savedTheme ? savedTheme === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            themeToggle.addEventListener('change', () => {
                const isDark = themeToggle.checked;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                applyTheme(isDark);
            });

            // --- Settings Panel Logic ---
            settingsToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = settingsPanel.classList.contains('hidden');
                if (isHidden) {
                    settingsPanel.classList.remove('hidden');
                    setTimeout(() => {
                        settingsPanel.classList.remove('opacity-0', 'scale-95');
                    }, 10);
                } else {
                    settingsPanel.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => settingsPanel.classList.add('hidden'), 300);
                }
            });
            document.addEventListener('click', (e) => {
                if (!settingsPanel.contains(e.target) && !settingsToggle.contains(e.target) && !settingsPanel.classList.contains('hidden')) {
                    settingsPanel.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => settingsPanel.classList.add('hidden'), 300);
                }
            });

            // --- Font & Image Size Control Logic ---
            const applyFontSize = (elements, size) => {
                elements.forEach(el => { if(el) el.style.fontSize = `${size}px` });
            };
            
            const applyImageSize = (element, size) => {
                if (element) {
                    element.style.width = `${size}%`;
                }
            };

            const applyCardWidth = (element, size) => {
                if (element) {
                    element.style.maxWidth = `${size}px`;
                }
            };

            const setupSlider = (slider, storageKey, applyFn, valueSpan, elements, valueSuffix = 'px') => {
                const savedSize = localStorage.getItem(storageKey);
                const initialSize = savedSize || slider.value;
                slider.value = initialSize;
                applyFn(elements, initialSize);
                if (valueSpan) valueSpan.textContent = `${initialSize}${valueSuffix}`;
                
                slider.addEventListener('input', (e) => {
                    const newSize = e.target.value;
                    applyFn(elements, newSize);
                    localStorage.setItem(storageKey, newSize);
                    if (valueSpan) valueSpan.textContent = `${newSize}${valueSuffix}`;
                    updateSpacingIndicators();
                });
            };

            setupSlider(questionSizeSlider, 'fontSize_question', applyFontSize, questionSizeValue, allQuestionText);
            setupSlider(instructionSizeSlider, 'fontSize_instruction', applyFontSize, instructionSizeValue, allInstructionText);
            setupSlider(choiceSizeSlider, 'fontSize_choice', applyFontSize, choiceSizeValue, allChoiceText);
            setupSlider(imageSizeSlider, 'imageSize_welcome', applyImageSize, imageSizeValue, welcomeImage, '%');
            setupSlider(cardWidthSlider, 'cardWidth', applyCardWidth, cardWidthValue, mainContent);

            // --- Survey Logic ---
            const enableNextButton = () => {
                nextButton.disabled = false;
                nextButton.classList.remove('bg-gray-200', 'text-gray-500', 'dark:bg-gray-700', 'dark:text-gray-400');
                nextButton.classList.add('bg-apple-blue', 'text-white', 'cursor-pointer', 'hover:bg-blue-700');
            };

            const disableNextButton = () => {
                nextButton.disabled = true;
                nextButton.classList.add('bg-gray-200', 'text-gray-500', 'dark:bg-gray-700', 'dark:text-gray-400');
                nextButton.classList.remove('bg-apple-blue', 'text-white', 'cursor-pointer', 'hover:bg-blue-700');
            }

            const checkRadioMatrixCompletion = (questionContainer) => {
                const instructionEl = questionContainer.querySelector('.instruction-text');
                const rows = questionContainer.querySelectorAll('tbody tr, #bipolar-flex-choices > div');
                const allAnswered = [...rows].every(row => row.querySelector('input[type="radio"]:checked'));
                if (allAnswered) {
                    instructionEl.classList.remove('error');
                    enableNextButton();
                } else {
                    disableNextButton();
                }
                return allAnswered;
            };

            const checkMatrixMultiSelectCompletion = (questionContainer) => {
                const instructionEl = questionContainer.querySelector('.instruction-text');
                const rows = questionContainer.querySelectorAll('tbody tr');
                const allAnswered = [...rows].every(row => row.querySelector('input[type="checkbox"]:checked'));
                 if (allAnswered) {
                    instructionEl.classList.remove('error');
                    enableNextButton();
                } else {
                    disableNextButton();
                }
                return allAnswered;
            }
            
            const checkMultiSelectCompletion = () => {
                const checkboxes = document.querySelectorAll('#question-4 input[type="checkbox"]');
                const isAnyChecked = [...checkboxes].some(cb => cb.checked);
                const instructionEl = questionContainers[3].querySelector('.instruction-text');
                if (isAnyChecked) {
                    instructionEl.classList.remove('error');
                    enableNextButton();
                } else {
                    disableNextButton();
                }
                return isAnyChecked;
            };

            const checkConstantSum = () => {
                const inputs = document.querySelectorAll('.cs-input');
                const totalEl = document.getElementById('constant-sum-total');
                const instructionEl = questionContainers[6].querySelector('.instruction-text');
                let total = 0;
                inputs.forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                totalEl.value = total;

                // Reset total color
                totalEl.classList.remove('text-red-600', 'dark:text-red-500');
                totalEl.classList.add('text-gray-800', 'dark:text-gray-100');

                if (total === 100) {
                    instructionEl.classList.remove('error');
                    enableNextButton();
                } else {
                    disableNextButton();
                    if (total > 100) {
                        instructionEl.classList.add('error');
                        totalEl.classList.add('text-red-600', 'dark:text-red-500');
                        totalEl.classList.remove('text-gray-800', 'dark:text-gray-100');
                    } else {
                        instructionEl.classList.remove('error');
                    }
                }
            };

            const updateRanks = (movedItem) => {
                hasBeenDragged = true;
                rankOrderList.classList.add('is-ranked');
                const items = rankOrderList.querySelectorAll('.rank-item');
                items.forEach((item, index) => {
                    const badge = item.querySelector('.rank-badge');
                    badge.textContent = index + 1;
                    badge.classList.remove('unranked');
                    badge.classList.add('ranked');
                });
                enableNextButton();
            };

            new Sortable(rankOrderList, {
                animation: 150,
                onEnd: (evt) => updateRanks(evt.item),
            });

            const showStep = (stepNumber) => {
                currentStep = stepNumber;
                questionJump.value = currentStep; 

                stepContainers.forEach(c => c.classList.add('hidden'));
                questionContainers.forEach(c => c.classList.add('hidden'));
                
                if (stepNumber === 0) { 
                    stepContainers[0].classList.remove('hidden');
                    nextButtonContainer.classList.remove('hidden');
                    enableNextButton();
                } else if (stepNumber > 0 && stepNumber <= totalQuestions) { 
                    stepContainers[1].classList.remove('hidden');
                    const questionIndex = stepNumber - 1;
                    questionContainers[questionIndex].classList.remove('hidden');
                    progressBar.style.width = `${((stepNumber - 1) / totalQuestions) * 100}%`;
                    disableNextButton(); 
                } else { // Thank You Screen
                    stepContainers[2].classList.remove('hidden');
                    nextButtonContainer.classList.add('hidden');
                }

                // Always show 'Next' on question pages
                nextButton.textContent = 'Next';

                if(stepNumber > 0 && stepNumber <= totalQuestions) {
                    const currentQContainer = questionContainers[stepNumber - 1];
                     switch (stepNumber) {
                        case 1:
                            if ([...currentQContainer.querySelectorAll('input:checked')].length > 0) enableNextButton();
                            break;
                        case 2:
                        case 3:
                        case 9:
                        case 10:
                            checkRadioMatrixCompletion(currentQContainer);
                            break;
                        case 4:
                            checkMultiSelectCompletion();
                            break;
                        case 5:
                            checkMatrixMultiSelectCompletion(currentQContainer);
                            break;
                        case 6:
                            enableNextButton();
                            break;
                        case 7:
                            checkConstantSum();
                            break;
                        case 8:
                            if(hasBeenDragged) enableNextButton();
                            break;
                    }
                }
                updateSpacingIndicators();
            };

            // --- Spacing Indicator Logic ---
            const updateSpacingIndicators = () => {
                cancelAnimationFrame(resizeObserverFrameId);
                resizeObserverFrameId = requestAnimationFrame(() => {
                    document.querySelectorAll('.spacing-indicator').forEach(el => el.classList.add('hidden'));
                    if (!spacingToggle.checked || currentStep === 0 || currentStep > totalQuestions) return;

                    const mainRect = mainContent.getBoundingClientRect();
                    const currentQContainer = questionContainers[currentStep - 1];
                    if (!currentQContainer) return;

                    const elements = [
                        document.getElementById('logo-container-small'),
                        document.getElementById('progress-container'),
                        currentQContainer.querySelector('.instruction-text').parentElement,
                        currentQContainer.querySelector('.choices-container'),
                        nextButtonContainer
                    ];

                    const spacers = [
                        document.getElementById('spacer-1'),
                        document.getElementById('spacer-2'),
                        document.getElementById('spacer-3'),
                        document.getElementById('spacer-4')
                    ];
                    
                    for (let i = 0; i < spacers.length; i++) {
                        const topEl = elements[i];
                        const bottomEl = elements[i+1];
                        if (topEl && bottomEl && spacers[i]) {
                            const topRect = topEl.getBoundingClientRect();
                            const bottomRect = bottomEl.getBoundingClientRect();
                            const space = bottomRect.top - topRect.bottom;
                            
                            if (space > 0) {
                                spacers[i].style.height = `${space}px`;
                                spacers[i].style.top = `${topRect.bottom - mainRect.top}px`;
                                spacers[i].textContent = `${Math.round(space)}px`;
                                spacers[i].classList.remove('hidden');
                            }
                        }
                    }
                });
            };

            spacingToggle.addEventListener('change', () => {
                 if (spacingToggle.checked) {
                    updateSpacingIndicators();
                } else {
                    document.querySelectorAll('.spacing-indicator').forEach(el => el.classList.add('hidden'));
                }
            });

            new ResizeObserver(updateSpacingIndicators).observe(mainContent);

            // --- Event Listeners ---
            document.body.addEventListener('change', (e) => {
                if (currentStep === 0 || currentStep > totalQuestions) return;

                const currentQContainer = questionContainers[currentStep - 1];
                
                switch (currentStep) {
                    case 1:
                        if (e.target.type === 'radio') {
                            const instructionEl = currentQContainer.querySelector('.instruction-text');
                            instructionEl.classList.remove('error');
                            enableNextButton();
                        }
                        break;
                    case 2:
                    case 3:
                    case 9:
                    case 10:
                        checkRadioMatrixCompletion(currentQContainer);
                        break;
                    case 4:
                        const noneOfTheAbove = document.getElementById('q4-none');
                        if (e.target.type === 'checkbox') {
                            if (e.target.checked && e.target.id === 'q4-none') {
                                currentQContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { if (cb.id !== 'q4-none') cb.checked = false; });
                            } else if (e.target.checked) {
                                noneOfTheAbove.checked = false;
                            }
                        }
                        checkMultiSelectCompletion();
                        break;
                    case 5:
                        checkMatrixMultiSelectCompletion(currentQContainer);
                        break;
                }
            });

            document.getElementById('choices-7-container').addEventListener('input', (e) => {
                if (e.target.classList.contains('cs-input')) {
                    checkConstantSum();
                }
            });
            
            questionJump.addEventListener('change', (e) => {
                const stepNum = parseInt(e.target.value);
                history.pushState({ step: stepNum }, '', `#step-${stepNum}`);
                showStep(stepNum);
            });

            nextButtonContainer.addEventListener('click', (e) => {
                if (nextButton.disabled) {
                    if (currentStep > 0 && currentStep <= totalQuestions) {
                        const instructionEl = questionContainers[currentStep - 1].querySelector('.instruction-text');
                        if (instructionEl) {
                            instructionEl.classList.add('error');
                        }
                    }
                    return;
                }

                const nextStep = currentStep + 1;
                history.pushState({ step: nextStep }, '', `#step-${nextStep}`);
                showStep(nextStep);
            });

            // Handle browser back/forward
            window.addEventListener('popstate', (event) => {
                const step = event.state ? event.state.step : 0;
                showStep(step);
            });
            
            // Handle initial load
            const initialStep = location.hash.startsWith('#step-') ? parseInt(location.hash.replace('#step-', '')) : 0;
            const initialImageSize = imageSizeSlider.value;
            applyImageSize(welcomeImage, initialImageSize);
            imageSizeValue.textContent = `${initialImageSize}%`;

            showStep(initialStep);
        });
    </script>

</body>
</html>
